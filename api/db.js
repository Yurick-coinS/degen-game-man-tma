// Подключаем инструмент для работы с базой данных, который мы настроили ранее
const pool = require('../db'); // Обрати внимание на путь '../db'

// ЭТО -- ГЛАВНАЯ ЧАСТЬ. Мы экспортируем функцию, которую будет вызывать Vercel
module.exports = async (req, res) => {
	try {
		// Пытаемся получить соединение из пула
		const client = await pool.connect();

		try {
			// Выполняем тестовый запрос
			const result = await client.query('SELECT NOW()');

			// Если все успешно, отправляем ответ в браузер
			// И в лог Vercel мы тоже увидим это сообщение
			console.log('Морфеус: Рукопожатие успешно.');
			res.status(200).json({
				message: 'Морфеус: Рукопожатие с базой данных успешно. Система видит матрицу.',
				time: result.rows[0].now
			});

		} finally {
			// ВСЕГДА отпускаем соединение обратно в пул, даже если была ошибка
			client.release();
		}
	} catch (error) {
		// Если произошла ошибка подключения
		console.error('Морфеус: КРИТИЧЕСКАЯ ОШИБКА!', error);
		res.status(500).json({
			message: 'Морфеус: КРИТИЧЕСКАЯ ОШИБКА! Не удалось установить рукопожатие с базой данных.',
			error: error.message
		});
	}
};