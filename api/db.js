// Подключаем встроенный инструмент для работы с путями к файлам
const path = require('path');

// Загружаем наш секретный ключ, указывая точный путь к файлу .env
// Он ищет файл .env в папке, которая находится на один уровень выше текущей (в корне проекта)
require('dotenv').config({ path: path.resolve(__dirname, '../.env') });

// Эта строка подключает инструмент для работы с базой данных PostgreSQL
const { Pool } = require('pg');

// Эта строка создает "пул соединений", используя наш секретный ключ
// Убедись, что переменная DATABASE_URL правильно записана в твоем .env файле
const pool = new Pool({
	connectionString: process.env.DATABASE_URL,
});

// Эта функция пытается соединиться и доложить о результате
pool.connect((err, client, release) => {
	if (err) {
		// Если ошибка в самом подключении (неверный пароль, адрес) - выводим это
		return console.error('Морфеус: КРИТИЧЕСКАЯ ОШИБКА! Рукопожатие не установлено. Проверь строку DATABASE_URL в файле .env.', err.stack);
	}
	// Если подключение успешно, выполняем тестовый запрос
	client.query('SELECT NOW()', (err, result) => {
		release(); // Всегда отпускаем соединение после использования
		if (err) {
			// Если ошибка на этапе запроса (редко, но возможно)
			return console.error('Морфеус: ОШИБКА! Рукопожатие было, но тестовый запрос провалился.', err.stack);
		}
		// Если все прошло идеально, выводим сообщение об успехе
		console.log('Морфеус: Рукопожатие с базой данных успешно. Система видит матрицу. Время:', result.rows[0].now);
	});
});

// Экспортируем наш "пул", чтобы другие части кода могли им пользоваться в будущем
module.exports = pool;
// Trigger redeploy